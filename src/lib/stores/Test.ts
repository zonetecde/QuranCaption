let object = [
	{
		id: 0,
		seek: 0,
		start: 2.68,
		end: 7.0,
		text: ' الحمد لله رب العالمين',
		tokens: [50364, 21542, 2304, 3215, 24976, 3224, 12602, 3555, 18863, 45340, 9957, 50714],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' الحمد',
				start: 2.68,
				end: 4.08,
				probability: 0.8485967914263407
			},
			{
				word: ' لله',
				start: 4.08,
				end: 4.9,
				probability: 0.9860214591026306
			},
			{
				word: ' رب',
				start: 4.9,
				end: 5.34,
				probability: 0.9746435284614563
			},
			{
				word: ' العالمين',
				start: 5.34,
				end: 7.0,
				probability: 0.994294265906016
			}
		]
	},
	{
		id: 1,
		seek: 0,
		start: 7.58,
		end: 10.2,
		text: ' الرحمن الرحيم',
		tokens: [50714, 34892, 5016, 27842, 34892, 5016, 32640, 50864],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' الرحمن',
				start: 7.58,
				end: 8.42,
				probability: 0.8752436836560568
			},
			{
				word: ' الرحيم',
				start: 8.42,
				end: 10.2,
				probability: 0.9803959528605143
			}
		]
	},
	{
		id: 2,
		seek: 0,
		start: 10.2,
		end: 13.48,
		text: ' مالك يوم الدين',
		tokens: [50864, 3714, 6027, 4117, 7251, 20498, 32748, 9957, 51014],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' مالك',
				start: 10.2,
				end: 11.2,
				probability: 0.9801499048868815
			},
			{
				word: ' يوم',
				start: 11.2,
				end: 11.78,
				probability: 0.9933081865310669
			},
			{
				word: ' الدين',
				start: 11.78,
				end: 13.48,
				probability: 0.9917545318603516
			}
		]
	},
	{
		id: 3,
		seek: 0,
		start: 13.48,
		end: 17.92,
		text: ' إياك نعبد وإياك نستعين',
		tokens: [
			51014, 11933, 25528, 4117, 8717, 3615, 44510, 4032, 28814, 25528, 4117, 8717, 14851, 3615,
			9957, 51264
		],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' إياك',
				start: 13.48,
				end: 14.42,
				probability: 0.9623938600222269
			},
			{
				word: ' نعبد',
				start: 14.42,
				end: 15.12,
				probability: 0.9824468890825907
			},
			{
				word: ' وإياك',
				start: 15.12,
				end: 16.32,
				probability: 0.9646236151456833
			},
			{
				word: ' نستعين',
				start: 16.32,
				end: 17.92,
				probability: 0.9880206286907196
			}
		]
	},
	{
		id: 4,
		seek: 0,
		start: 17.92,
		end: 21.06,
		text: ' إهدنا الصراط المستقيم',
		tokens: [51264, 11933, 3224, 3215, 8315, 31767, 2288, 41193, 9673, 14851, 4587, 32640, 51414],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' إهدنا',
				start: 17.92,
				end: 19.04,
				probability: 0.7955624461174011
			},
			{
				word: ' الصراط',
				start: 19.04,
				end: 19.84,
				probability: 0.923709511756897
			},
			{
				word: ' المستقيم',
				start: 19.84,
				end: 21.06,
				probability: 0.9668182134628296
			}
		]
	},
	{
		id: 5,
		seek: 0,
		start: 21.06,
		end: 25.16,
		text: ' صراط الذين أنعمت عليهم',
		tokens: [51414, 20328, 2288, 41193, 32545, 9957, 14739, 25957, 2655, 25894, 16095, 51614],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' صراط',
				start: 21.06,
				end: 22.04,
				probability: 0.9731274644533793
			},
			{
				word: ' الذين',
				start: 22.04,
				end: 22.82,
				probability: 0.9743446111679077
			},
			{
				word: ' أنعمت',
				start: 22.82,
				end: 23.88,
				probability: 0.9534869194030762
			},
			{
				word: ' عليهم',
				start: 23.88,
				end: 25.16,
				probability: 0.983904093503952
			}
		]
	},
	{
		id: 6,
		seek: 0,
		start: 25.16,
		end: 28.1,
		text: ' غير المغضوب عليهم',
		tokens: [51614, 32771, 13546, 9673, 17082, 11242, 37746, 25894, 16095, 51764],
		temperature: 0.0,
		avg_logprob: -0.1216756308951029,
		compression_ratio: 1.893939393939394,
		no_speech_prob: 0.6409443616867065,
		words: [
			{
				word: ' غير',
				start: 25.16,
				end: 26.1,
				probability: 0.9659727811813354
			},
			{
				word: ' المغضوب',
				start: 26.1,
				end: 27.12,
				probability: 0.9696334004402161
			},
			{
				word: ' عليهم',
				start: 27.12,
				end: 28.1,
				probability: 0.9943588078022003
			}
		]
	},
	{
		id: 7,
		seek: 2810,
		start: 28.1,
		end: 37.06,
		text: ' ودى الله ألين',
		tokens: [50364, 4032, 3215, 7578, 21984, 5551, 1211, 9957, 50814],
		temperature: 0.0,
		avg_logprob: -0.5873411178588868,
		compression_ratio: 0.9428571428571428,
		no_speech_prob: 0.33153197169303894,
		words: [
			{
				word: ' ودى',
				start: 28.1,
				end: 28.92,
				probability: 0.32174915572007495
			},
			{
				word: ' الله',
				start: 28.92,
				end: 32.18,
				probability: 0.6393794417381287
			},
			{
				word: ' ألين',
				start: 32.18,
				end: 37.06,
				probability: 0.33174970249334973
			}
		]
	},
	{
		id: 8,
		seek: 2810,
		start: 37.06,
		end: 38.46,
		text: ' أمين',
		tokens: [50814, 5551, 2304, 9957, 50914],
		temperature: 0.0,
		avg_logprob: -0.5873411178588868,
		compression_ratio: 0.9428571428571428,
		no_speech_prob: 0.33153197169303894,
		words: [
			{
				word: ' أمين',
				start: 37.06,
				end: 38.46,
				probability: 0.8747619787851969
			}
		]
	}
];

import { get } from 'svelte/store';
import type { Quran } from '$lib/models/Quran';
import type { SubtitleClip } from '$lib/models/Timeline';
import { Mushaf } from './QuranStore';

const normalizeText = (text: string) => {
	//remove special characters
	text = text.replace(/([^\u0621-\u063A\u0641-\u064A\u0660-\u0669a-zA-Z 0-9])/g, '');

	//normalize Arabic
	text = text.replace(/(آ|إ|أ)/g, 'ا');
	text = text.replace(/(ة)/g, 'ه');
	text = text.replace(/(ئ|ؤ)/g, 'ء');
	text = text.replace(/(ى)/g, 'ي');

	//convert arabic numerals to english counterparts.
	var starter = 0x660;
	for (var i = 0; i < 10; i++) {
		text.replace(String.fromCharCode(starter + i), String.fromCharCode(48 + i));
	}

	return text;
};

type VersePosition = {
	surah: number;
	verse: number;
	wordIndex: number;
};

export function processSegments(segments: any[]): SubtitleClip[] {
	segments = object;

	const quran = get(Mushaf);
	const normalizedQuran = preprocessQuran(quran);
	let currentPosition: VersePosition = { surah: 1, verse: 1, wordIndex: 0 };
	let remainingBuffer: string[] = [];

	return segments.map((segment) => {
		const segmentWords = normalizeText(segment.text).split(' ');
		remainingBuffer.push(...segmentWords);

		let bestMatch = findBestMatch(normalizedQuran, remainingBuffer, currentPosition);

		// Fallback si aucun match trouvé
		if (!bestMatch) {
			bestMatch = findFallbackMatch(normalizedQuran, remainingBuffer);
			remainingBuffer = [];
		} else {
			remainingBuffer = remainingBuffer.slice(bestMatch.usedWords);
			currentPosition = updatePosition(bestMatch);
		}

		return createSubtitleClip(segment, bestMatch);
	});
}

function preprocessQuran(quran: Quran) {
	return quran.surahs.map((surah) => ({
		...surah,
		verses: surah.verses.map((verse) => ({
			...verse,
			normalized: normalizeText(verse.text).split(' ')
		}))
	}));
}

function findBestMatch(quran: any[], buffer: string[], currentPos: VersePosition) {
	const maxLookahead = 5;
	const searchWindow = buffer.slice(0, 20); // Prend les 20 premiers mots

	let bestMatch = null;
	let highestScore = 0;

	// Recherche dans le contexte actuel d'abord
	const currentSurah = quran.find((s) => s.id === currentPos.surah);
	if (currentSurah) {
		// @ts-ignore
		const currentVerse = currentSurah.verses.find((v) => v.id === currentPos.verse);
		if (currentVerse) {
			const verseWords = currentVerse.normalized.slice(currentPos.wordIndex);
			const score = calculateMatchScore(verseWords, searchWindow);
			if (score > 0) {
				bestMatch = {
					surah: currentSurah.id,
					verse: currentVerse.id,
					startWord: currentPos.wordIndex,
					usedWords: Math.min(searchWindow.length, verseWords.length),
					score
				};
				highestScore = score;
			}
		}
	}

	// Recherche globale si nécessaire
	for (const surah of quran) {
		for (const verse of surah.verses) {
			for (let start = 0; start < verse.normalized.length; start++) {
				const verseSlice = verse.normalized.slice(start, start + maxLookahead);
				const score = calculateMatchScore(verseSlice, searchWindow);

				if (score > highestScore) {
					bestMatch = {
						surah: surah.id,
						verse: verse.id,
						startWord: start,
						usedWords: verseSlice.length,
						score
					};
					highestScore = score;
				}
			}
		}
	}

	return bestMatch;
}

function calculateMatchScore(verseWords: string[], segmentWords: string[]) {
	let score = 0;
	const maxLength = Math.min(verseWords.length, segmentWords.length);

	for (let i = 0; i < maxLength; i++) {
		if (verseWords[i] === segmentWords[i]) {
			score += 1 + (i === 0 ? 2 : 0); // Bonus pour le premier mot
		} else {
			break;
		}
	}
	return score;
}

function findFallbackMatch(quran: any[], buffer: string[]) {
	// Trouve le verset avec le plus grand nombre de mots correspondants
	let maxMatches = 0;
	let bestMatch = null;

	for (const surah of quran) {
		for (const verse of surah.verses) {
			const matches = countMatchingWords(verse.normalized, buffer);
			if (matches > maxMatches) {
				maxMatches = matches;
				bestMatch = {
					surah: surah.id,
					verse: verse.id,
					startWord: 0,
					usedWords: matches,
					score: matches
				};
			}
		}
	}

	return bestMatch || { surah: 1, verse: 1, startWord: 0, usedWords: 0, score: 0 };
}

function countMatchingWords(verseWords: string[], segmentWords: string[]) {
	const wordSet = new Set(verseWords);
	return segmentWords.filter((w) => wordSet.has(w)).length;
}

function updatePosition(match: any): VersePosition {
	return {
		surah: match.surah,
		verse: match.verse,
		wordIndex: match.startWord + match.usedWords
	};
}

function createSubtitleClip(segment: any, match: any): SubtitleClip {
	const quran = get(Mushaf);

	const isLastWord =
		match.startWord + match.usedWords ===
		quran.surahs[match.surah - 1].verses[match.verse - 1].text.length;

	return {
		id: `segment-${segment.id}`,
		start: segment.start,
		end: segment.end,
		text: segment.text,
		surah: match.surah,
		verse: match.verse,
		isSilence: segment.words.some((w: any) => w.probability < 0.5),
		firstWordIndexInVerse: match.startWord,
		lastWordIndexInVerse: match.startWord + match.usedWords - 1,
		isLastWordInVerse: isLastWord,
		translations: {},
		hadItTranslationEverBeenModified: false,
		isCustomText: match.score < 3 // Marque comme custom si score trop bas
	};
}
